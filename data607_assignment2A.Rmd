---
title: "Movies Ratings"
date: "2025-09-07"
output: html_document
---

```{r}
library(DBI)
library(RPostgres)
library(dplyr)
library(tidyr)
library(ggplot2)

dbname <- "data607_assignment2A"
user   <- "postgres"
host <- "localhost"
port <- 5432
```

```{r}
pwd <- Sys.getenv("PGPASSWORD", "")
if (pwd == "") {
  if (!requireNamespace("askpass", quietly = TRUE)) install.packages("askpass")
  pwd <- askpass::askpass("Postgres password")}
```

```{r}
con <- NULL
try({
  con <- dbConnect(
    RPostgres::Postgres(),
    host = host, port = port, dbname = dbname, user = user, password = pwd
  )
}, silent = TRUE)

if (!is.null(con)) {
  ratings <- dbGetQuery(con, "
    SELECT rater, movie, release_year, rating, rated_at
    FROM movieratings.v_ratings
    ORDER BY rater, movie;
  ")
  saveRDS(ratings, file = "ratings.rds")
  write.csv(ratings, "ratings_long.csv", row.names = FALSE)
  dbDisconnect(con)
} else {
  message("Could not connect to DB; trying CSV fallback...")
  if (file.exists("ratings.rds")) {
    ratings <- readRDS("ratings.rds")
  } else if (file.exists("ratings_long.csv")) {
    ratings <- read.csv("ratings_long.csv", stringsAsFactors = FALSE)
  } else {
    stop("No DB connection and no CSV fallback found. Run the SQL and re-knit, or place ratings_long.csv here.")
  }
}
```

```{r}
# table
ratings_wide <- ratings |>
  select(rater, movie, rating) |>
  pivot_wider(names_from = movie, values_from = rating)

ratings_wide
```

```{r}
# count missing values per movie
na_counts <- colSums(is.na(ratings_wide[, -1, drop = FALSE]))  # skip 'rater'
na_counts

# summary
movie_summary <- ratings |>
  group_by(movie) |>
  summarise(
    n_ratings   = n(),
    mean_rating = mean(rating, na.rm = TRUE),
    sd_rating   = sd(rating,   na.rm = TRUE),
    .groups = "drop"
  ) |>
  arrange(desc(mean_rating))

movie_summary
```


```{r} 
# simple imputation demo: fill NA with that movie's mean
ratings_imputed <- ratings_wide
for (col in names(ratings_imputed)[-1]) {  # skip 'rater'
  m   <- movie_summary$mean_rating[movie_summary$movie == col]
  nas <- is.na(ratings_imputed[[col]])
  ratings_imputed[[col]][nas] <- m
}
ratings_imputed
```

```{r}
# simple plot 
par(mar = c(9,4,3,1))
barplot(
  height    = movie_summary$mean_rating,
  names.arg = movie_summary$movie,
  las = 2,
  ylab = "Average rating (1â€“5)",
  main = "Average Movie Ratings"
)
```
# export CSVs for submission
write.csv(ratings_wide,  "ratings_wide.csv",  row.names = FALSE)
write.csv(movie_summary, "movie_summary.csv", row.names = FALSE)
"Saved ratings_wide.csv and movie_summary.csv"



